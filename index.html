<html>
<head>
  <title>Redirecting...</title>
  <script>
    function logScanAndRedirect() {
      // Check if this session already logged
      if (sessionStorage.getItem("hasLogged")) {
        console.log("Session already logged, skipping");
        window.location.href = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) 
          ? "whatsapp://send?phone=+447350273595&text=Here's+my+question:%20"
          : "https://wa.me/+447350273595?text=Here's+my+question:%20";
        return;
      }

      console.log("Starting logScanAndRedirect");

      const userAgent = navigator.userAgent;
      console.log("Raw User-Agent: " + userAgent);

      let device = "Unknown Device";
      let browser = "Unknown Browser/App";

      if (/Android/i.test(userAgent)) device = "Android";
      else if (/iPhone|iPad|iPod/i.test(userAgent)) device = "iPhone/iPad";
      else if (/Windows/i.test(userAgent)) device = "Windows Device";
      else if (/Macintosh|Mac OS/i.test(userAgent)) device = "Mac";

      if (/CriOS/i.test(userAgent)) browser = "Chrome";
      else if (/Chrome/i.test(userAgent)) browser = "Chrome";
      else if (/Firefox/i.test(userAgent)) browser = "Firefox";
      else if (/Edg/i.test(userAgent)) browser = "Edge";
      else if (/SamsungBrowser/i.test(userAgent)) browser = "Samsung Internet";
      else if (/UCBrowser|UCWEB/i.test(userAgent)) browser = "UC Browser";
      else if (/Opera|OPR/i.test(userAgent)) browser = "Opera";
      else if (/Safari/i.test(userAgent)) browser = "Safari";
      else if (/QR|Scan/i.test(userAgent)) browser = "QR Scanner App";

      console.log("Detected Device: " + device);
      console.log("Detected Browser: " + browser);

      const code = "TICQR1";
      const scriptUrl = "https://script.google.com/macros/s/AKfycbyn74NbHibh_IFNEa-wbgGT57m-11I_mf87F8t1vyd1ssqc3LVhWDsQmQqNQ5VSFxZm/exec";
      const whatsappUrl = /iPhone|iPad|iPod|Android/i.test(userAgent) 
        ? "whatsapp://send?phone=+447350273595&text=Here's+my+question:%20"
        : "https://wa.me/+447350273595?text=Here's+my+question:%20";

      const logUrl = `${scriptUrl}?device=${encodeURIComponent(device)}&code=${encodeURIComponent(code)}&browser=${encodeURIComponent(browser)}`;
      console.log("Logging to: " + logUrl);

      fetch(logUrl, { method: "GET" })
        .then(response => {
          console.log("Fetch response status: " + response.status);
          return response.text();
        })
        .then(text => {
          console.log("Log response: " + text);
          sessionStorage.setItem("hasLogged", "true"); // Mark as logged
          console.log("Redirecting to WhatsApp now");
          window.location.href = whatsappUrl;
        })
        .catch(error => {
          console.error("Fetch error: " + error);
          sessionStorage.setItem("hasLogged", "true"); // Mark even on error
          console.log("Redirecting to WhatsApp despite error");
          window.location.href = whatsappUrl;
        });
    }

    window.onload = logScanAndRedirect;
  </script>
</head>
<body>
  <p>Redirecting to WhatsApp...</p>
</body>
</html>
